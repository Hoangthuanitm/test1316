<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử kiểm tra - Từ vựng & Ngữ pháp 13-16</title>
    <style>
        body{font-family:'Segoe UI',sans-serif;margin:0;padding:20px;background:#f5f7fa;color:#333;}
        h1{text-align:center;color:#4A90E2;}
        .search{margin:20px 0;display:flex;gap:10px;}
        .search input{flex:1;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:16px;}
        table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);}
        th,td{border:1px solid #ddd;padding:10px;text-align:center;font-size:14px;}
        th{background:#4A90E2;color:#fff;}
        tr:nth-child(even){background:#f9f9f9;}
        .delete{background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;}
        .delete:hover{background:#c0392b;}
        .A{color:#4A90E2;font-weight:bold;}
        .F{color:#e74c3c;font-weight:bold;}
        .msg{color:#e74c3c;margin:15px 0;text-align:center;}
    </style>
</head>
<body>
    <h1>Lịch sử kiểm tra – Từ vựng & Ngữ pháp 13-16</h1>
    <div class="search">
        <input type="text" id="search" placeholder="Tìm theo tên, lớp hoặc ngày...">
    </div>
    <div id="msg" class="msg"></div>

    <table>
        <thead>
            <tr>
                    <th>Thời gian bắt đầu</th>
                    <th>Thời gian kết thúc</th>
                    <th>Ngày</th>
                    <th>Tên</th>
                    <th>Lớp</th>
                    <th>問題 I</th>
                    <th>問題 II</th>
                    <th>問題 III</th>
                    <th>問題 IV</th>
                    <th>問題 V</th>
                    <th>問題 VI</th>
                    <th>Tổng</th>
                    <th>Tỷ lệ</th>
                    <th>Xếp loại</th>
                    <th>Thao tác</th>
                </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyAfy4QMD9_7PyFHpInNdKDRWuW4AYCtLJ4",
            authDomain: "history-e4633.firebaseapp.com",
            projectId: "history-e4633",
            storageBucket: "history-e4633.firebasestorage.app",
            messagingSenderId: "331974436893",
            appId: "1:331974436893:web:10c3c6adf7b66d2b5fbef4"
        });

        const db = getFirestore(app);
        const COLLECTION = "testHistorytuvungnguphap13-16";   // ĐÚNG CHÍNH XÁC

        function rank(p){
            if(p>=80)return {t:"A",c:"A"};
            if(p>=60)return {t:"B",c:""};
            if(p>=40)return {t:"C",c:""};
            if(p>=20)return {t:"D",c:""};
            return {t:"F",c:"F"};
        }

        async function load(){
            const tbody = document.getElementById("tbody");
            const msg = document.getElementById("msg");
            const keyword = document.getElementById("search").value.trim().toLowerCase();

            tbody.innerHTML = "<tr><td colspan='15'>Đang tải...</td></tr>";

            try {
                const snap = await getDocs(collection(db, COLLECTION));
                let rows = snap.docs.map(d => ({id: d.id, ...d.data()}));

                // Sắp xếp mới nhất trước
                rows.sort((a,b) => (b.endTime||"").localeCompare(a.endTime||""));

                // Lọc
                if(keyword){
                    rows = rows.filter(r =>
                        (r.name||"").toLowerCase().includes(keyword) ||
                        (r.class||"").toLowerCase().includes(keyword) ||
                        (r.date||"").includes(keyword)
                    );
                }

                if(rows.length===0){
                    tbody.innerHTML = "<tr><td colspan='15'>Không có dữ liệu nào.</td></tr>";
                    return;
                }

                tbody.innerHTML = rows.map(r => {
                    const rk = rank(r.percentage||0);
                    return `
                        <tr>
                            <td>${r.startTime||"-"}</td>
                            <td>${r.endTime||"-"}</td>
                            <td>${r.date||"-"}</td>
                            <td>${r.name||"-"}</td>
                            <td>${r.class||"-"}</td>
                            <td>${r.section1||0}/14</td>
                            <td>${r.section2||0}/12</td>
                            <td>${r.section3||0}/32</td>
                            <td>${r.section4||0}/12</td>
                            <td>${r.section5||0}/12</td>
                            <td>${r.section6||0}/18</td>
                            <td>${r.total||0}/100</td>
                            <td>${Math.round(r.percentage||0)}%</td>
                            <td class="${rk.c}">${rk.t}</td>
                            <td><button class="delete" data-id="${r.id}">Xóa</button></td>
                        </tr>`;
                }).join("");

                msg.textContent = "";
            } catch (e) {
                console.error(e);
                msg.textContent = "Lỗi kết nối Firestore. Kiểm tra mạng hoặc rule Firestore.";
            }
        }

        // Xóa
        document.getElementById("tbody").addEventListener("click", async e=>{
            if(e.target.classList.contains("delete")){
                if(confirm("Xóa bản ghi này?")){
                    const id = e.target.dataset.id;
                    await deleteDoc(doc(db, COLLECTION, id));
                    load();
                }
            }
        });

        // Tìm kiếm realtime
        document.getElementById("search").addEventListener("input", load);

        // Load lần đầu
        load();
    </script>
</body>
</html>
